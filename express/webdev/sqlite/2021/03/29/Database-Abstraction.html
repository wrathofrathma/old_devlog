<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Creating a REST API with Express.js (4/X): Database abstraction | Rathma’s Devlog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Creating a REST API with Express.js (4/X): Database abstraction" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Building a class to abstract database interactions and error handling." />
<meta property="og:description" content="Building a class to abstract database interactions and error handling." />
<link rel="canonical" href="https://www.kyso.dev/express/webdev/sqlite/2021/03/29/Database-Abstraction.html" />
<meta property="og:url" content="https://www.kyso.dev/express/webdev/sqlite/2021/03/29/Database-Abstraction.html" />
<meta property="og:site_name" content="Rathma’s Devlog" />
<meta property="og:image" content="https://www.kyso.dev/images/express.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-29T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Building a class to abstract database interactions and error handling.","url":"https://www.kyso.dev/express/webdev/sqlite/2021/03/29/Database-Abstraction.html","@type":"BlogPosting","headline":"Creating a REST API with Express.js (4/X): Database abstraction","dateModified":"2021-03-29T00:00:00-05:00","datePublished":"2021-03-29T00:00:00-05:00","image":"https://www.kyso.dev/images/express.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.kyso.dev/express/webdev/sqlite/2021/03/29/Database-Abstraction.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://www.kyso.dev/feed.xml" title="Rathma's Devlog" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Rathma&#39;s Devlog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Creating a REST API with Express.js (4/X): Database abstraction</h1><p class="page-description">Building a class to abstract database interactions and error handling.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-03-29T00:00:00-05:00" itemprop="datePublished">
        Mar 29, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      13 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#express">express</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#webdev">webdev</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#sqlite">sqlite</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#overview">Overview</a></li>
<li class="toc-entry toc-h1"><a href="#sqlite-error-handling">Sqlite error handling</a>
<ul>
<li class="toc-entry toc-h2"><a href="#callbacks">Callbacks</a>
<ul>
<li class="toc-entry toc-h3"><a href="#dbonevent-callback">db.on(‘event’, callback)</a></li>
<li class="toc-entry toc-h3"><a href="#dbrunsql-params-callback">db.run(sql, params, callback)</a></li>
<li class="toc-entry toc-h3"><a href="#dbexecsql-callback">db.exec(sql, callback)</a></li>
<li class="toc-entry toc-h3"><a href="#exception-catching">Exception catching</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#database-abstraction">Database abstraction</a>
<ul>
<li class="toc-entry toc-h2"><a href="#input-sanitization">Input sanitization</a></li>
<li class="toc-entry toc-h2"><a href="#more-useful-exceptions">More useful exceptions</a></li>
<li class="toc-entry toc-h2"><a href="#models">Models</a>
<ul>
<li class="toc-entry toc-h3"><a href="#user-model">User Model</a>
<ul>
<li class="toc-entry toc-h4"><a href="#creating-a-user">Creating a user</a></li>
<li class="toc-entry toc-h4"><a href="#fetching-a-user">Fetching a user</a></li>
<li class="toc-entry toc-h4"><a href="#updating-user-data">Updating user data</a></li>
<li class="toc-entry toc-h4"><a href="#deleting-a-user">Deleting a user</a></li>
<li class="toc-entry toc-h4"><a href="#fetching-user-tweets">Fetching user tweets</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#tweetmodel">TweetModel</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#unit-testing">Unit Testing</a>
<ul>
<li class="toc-entry toc-h2"><a href="#unit-testing-usermodel">Unit testing UserModel</a>
<ul>
<li class="toc-entry toc-h3"><a href="#creating-a-user-1">Creating a user</a></li>
<li class="toc-entry toc-h3"><a href="#fetching-a-user-1">Fetching a user</a></li>
<li class="toc-entry toc-h3"><a href="#updating-a-user">Updating a user</a></li>
<li class="toc-entry toc-h3"><a href="#deleting-a-user-1">Deleting a user</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#closing">Closing</a></li>
<li class="toc-entry toc-h1"><a href="#references">References</a></li>
</ul><h1 id="overview">
<a class="anchor" href="#overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview</h1>
<p>So I was considering what I wanted to do next and I think the short term roadmap for a functional REST API is realistically to handle routing, functions to handle the requests, authentication, and error handling. However, before we do any of that, it’d be nice to abstract our database interactions. This would allow us to perform unit tests on specific actions, as well as prevent us from rewriting the same code over and over.</p>

<p>So this post will cover building these abstractions, sanitizing input, and handling database errors.</p>

<p><a href="https://www.kyso.dev/express/webdev/jest/unit%20test/sqlite/2021/03/25/Unit-Testing.html">Previous Post: Unit Testing</a></p>

<p>All code from this project can be found here</p>

<p><a href="https://github.com/wrathofrathma/rest-express">https://github.com/wrathofrathma/rest-express</a></p>

<p>Code from this post can be found here</p>

<p><a href="https://github.com/wrathofrathma/rest-express/tree/b5bd089a2520d356dc4523dc8af95b7ad4f0fe0e">https://github.com/wrathofrathma/rest-express/tree/b5bd089a2520d356dc4523dc8af95b7ad4f0fe0e</a></p>

<h1 id="sqlite-error-handling">
<a class="anchor" href="#sqlite-error-handling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sqlite error handling</h1>
<p>To be honest, I think the error handling is a complete shit show. Maybe it’s my lack of experience with javascript, but neither the <a href="">sqlite documentation</a> nor the <a href="https://github.com/mapbox/node-sqlite3/wiki/API#databaserunsql-param--callback">sqlite3 documentation</a> cover how to do error handling properly with this setup. Since this is more about the journey, I’ll go over my problem solving process and the correct solution will be at the end.</p>

<h2 id="callbacks">
<a class="anchor" href="#callbacks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Callbacks</h2>
<p>The first way I tried was what the <a href="https://github.com/mapbox/node-sqlite3/wiki/API#databaserunsql-param--callback">sqlite3 documentation</a> suggests. Passing a callback to <code class="language-plaintext highlighter-rouge">db.run(sql, params, cb)</code>.</p>

<p>I tried creating a very basic print callback and not once would it be executed during my unit testing.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="dl">"</span><span class="s2">INSERT INTO users (username, password) VALUES (?, ?);</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Normal</span><span class="dl">"</span><span class="p">);</span>
<span class="p">})</span>
</code></pre></div></div>

<p>I tried a handful of variations with arrow functions, <code class="language-plaintext highlighter-rouge">db.exec()</code> instead, dropping the parameters, etc. I get the feeling that this wasn’t ported to the <code class="language-plaintext highlighter-rouge">sqlite</code> package.</p>

<h3 id="dbonevent-callback">
<a class="anchor" href="#dbonevent-callback" aria-hidden="true"><span class="octicon octicon-link"></span></a>db.on(‘event’, callback)</h3>
<p>After failing with that, I figured I’d try tracing sqlite errors the way <a href="https://www.npmjs.com/package/sqlite#tracing-sql-errors">both documentations</a> suggest.</p>

<p>When I create the database object, use <code class="language-plaintext highlighter-rouge">db.on('some_event', [callbacks])</code> to create callbacks when specific events fire on the database object. The <a href="https://github.com/mapbox/node-sqlite3/wiki/API">sqlite3 API</a> states</p>

<h3 id="dbrunsql-params-callback">
<a class="anchor" href="#dbrunsql-params-callback" aria-hidden="true"><span class="octicon octicon-link"></span></a>db.run(sql, params, callback)</h3>
<blockquote>
  <p>sql: The SQL query to run. If the SQL query is invalid and a callback was passed to the function, it is called with an error object containing the error message from SQLite. If no callback was passed and preparing fails, an error event will be emitted on the underlying Statement object.</p>
</blockquote>

<h3 id="dbexecsql-callback">
<a class="anchor" href="#dbexecsql-callback" aria-hidden="true"><span class="octicon octicon-link"></span></a>db.exec(sql, callback)</h3>
<blockquote>
  <p>Runs all SQL queries in the supplied string. No result rows are retrieved. The function returns the Database object to allow for function chaining. If a query fails, no subsequent statements will be executed (wrap it in a transaction if you want all or none to be executed). When all statements have been executed successfully, or when an error occurs, the callback function is called, with the first parameter being either null or an error object. When no callback is provided and an error occurs, an error event will be emitted on the database object.</p>
</blockquote>

<p>If we don’t specify an error callback, which ours isn’t even working, then the errors are emitted on the database object. So I attempted to listen for the <code class="language-plaintext highlighter-rouge">error</code> event by adding a callback when I create the database.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">sqlite3</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">sqlite3</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">open</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">sqlite</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">sqlite3</span><span class="p">.</span><span class="nx">verbose</span><span class="p">();</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nx">openDb</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">open</span><span class="p">({</span>
        <span class="na">filename</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./sqlite.db</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">driver</span><span class="p">:</span> <span class="nx">sqlite3</span><span class="p">.</span><span class="nx">Database</span>
    <span class="p">});</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRAGMA foreign_keys = ON;</span><span class="dl">"</span><span class="p">);</span>

    <span class="nx">db</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">sql</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sql</span><span class="p">);</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">db</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Alas, this didn’t work either. I didn’t really get anything out of the error event. Yet another thing that didn’t transfer from <code class="language-plaintext highlighter-rouge">sqlite3</code> to the  <code class="language-plaintext highlighter-rouge">sqlite</code> package. I also tried hooking into the inner <code class="language-plaintext highlighter-rouge">sqlite3.Database</code> property of the <code class="language-plaintext highlighter-rouge">db</code> object, but that too didn’t work.</p>

<h3 id="exception-catching">
<a class="anchor" href="#exception-catching" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exception catching</h3>
<p>So, I didn’t think to try this method immediately since the documentation didn’t mention it, and I had issues error handling this way with passing errors to express’ route error handles. However, catching the errors using promise catches or vanilla try/catch statements worked fine for not crashing the entire program.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="dl">"</span><span class="s2">INSERT INTO users (username, password) VALUES (?, ?);</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">])</span>
<span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This also worked just as well</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="dl">"</span><span class="s2">INSERT INTO users (username, password) VALUES (?, ?);</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">]);</span>
    
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We do need to still handle the error, but at least we have a starting place.</p>

<h1 id="database-abstraction">
<a class="anchor" href="#database-abstraction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Database abstraction</h1>

<p>Database abstraction is a good idea because it allows us to narrow the surface area of our testing for database interactions, maximize code reuse, and is likely going to be significantly more readable.</p>
<h2 id="input-sanitization">
<a class="anchor" href="#input-sanitization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Input sanitization</h2>
<p>A big issue in the database world is SQL injections, which typically occur when you don’t sanitize your inputs or process them properly.</p>

<p>Curious about this, I looked around at how to best structure my inputs and found this <a href="https://github.com/mapbox/node-sqlite3/issues/57">git issue: Defending against SQL injections</a>.</p>

<blockquote>
  <p>SQLite protects you against SQL injections if you specify user-supplied data as part of the params rather than stringing together an SQL query:</p>

  <p>BAD: db.prepare(“INSERT INTO foo VALUES(“ + variable + “)”);</p>

  <p>GOOD: db.prepare(“INSERT INTO foo VALUES (?)”, variable);</p>

  <p>By using the placeholder ?, SQLite automatically treats the data as input data and it does not interfere with parsing the actual SQL statement.</p>
</blockquote>

<h2 id="more-useful-exceptions">
<a class="anchor" href="#more-useful-exceptions" aria-hidden="true"><span class="octicon octicon-link"></span></a>More useful exceptions</h2>

<p>The errors generated from our database are good, but they’re a bit low level for how we will want express.js to represent these errors later.</p>

<p>So let’s create a generic exception class to just contain a bit of extra data. I created a <code class="language-plaintext highlighter-rouge">server/exceptions/</code> folder to house possible future exceptions, and created a <code class="language-plaintext highlighter-rouge">GenericException.js</code> in that folder to start with.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// We're going to have our own, slightly more descriptive exception class.</span>
<span class="cm">/**
 * Slightly more descriptive error handling.
 * - message: Descriptive error message 
 * - status: HTTP status code
 * - code: Error code
 * 
 */</span>
<span class="kd">class</span> <span class="nx">Exception</span> <span class="kd">extends</span> <span class="nb">Error</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">({</span><span class="nx">message</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">code</span><span class="p">})</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Exception</span><span class="p">;</span>
</code></pre></div></div>

<p>Now when we encounter an error, we can propagate useful information with it.</p>

<p>To use our new exception class, all we need to do is the following</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Exception</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">some_path/exceptions/GenericException</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// do stuff</span>
<span class="p">...</span>
<span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">({</span>
    <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Some useful error message</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">status</span><span class="p">:</span> <span class="mi">404</span><span class="p">,</span> <span class="c1">// any http code</span>
    <span class="na">code</span><span class="p">:</span> <span class="dl">"</span><span class="s2">E_SOME_USEFUL_ERROR</span><span class="dl">"</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="models">
<a class="anchor" href="#models" aria-hidden="true"><span class="octicon octicon-link"></span></a>Models</h2>
<p>Models are classes that will encapsulate most, or all, of our database logic. There are many different ways to design these, but as long as we stay true to our goal of abstracting the actions we’ll perform on the database, we’ll be fine. Functionally most of the SQL and code will be similar to when we were unit testing our database, we’re just making it easier to use and handling exceptions.</p>

<p>We first should create a directory for our models, <code class="language-plaintext highlighter-rouge">server/models/</code>.</p>

<h3 id="user-model">
<a class="anchor" href="#user-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>User Model</h3>
<p>Inside the models directory, we’ll create a <code class="language-plaintext highlighter-rouge">UserModel.js</code> file.</p>

<p>When I scaffold out my models, and most of my classes, I ask myself what kind of actions I want to perform and what data I want my class to store/track.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">UserModel</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">({</span><span class="nx">id</span><span class="p">,</span> <span class="nx">username</span> <span class="nx">password</span><span class="p">})</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">username</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">static</span> <span class="k">async</span> <span class="nx">create</span><span class="p">({</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">}){</span>
        <span class="c1">// Create new user</span>
    <span class="p">}</span>
    <span class="kd">static</span> <span class="k">async</span> <span class="kd">get</span><span class="p">({</span><span class="nx">id</span><span class="p">,</span> <span class="nx">username</span><span class="p">})</span> <span class="p">{</span>
        <span class="c1">// Fetch user based off of id or username</span>
    <span class="p">}</span>
    <span class="k">async</span> <span class="nx">update</span><span class="p">({</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">})</span> <span class="p">{</span>
        <span class="c1">// Update user data</span>
    <span class="p">}</span>
    <span class="k">async</span> <span class="k">delete</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Delete user</span>
    <span class="p">}</span>
    <span class="k">async</span> <span class="nx">tweets</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Fetches all of the user's tweets</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">UserModel</span><span class="p">;</span>
</code></pre></div></div>

<p>Then I start to fill out the functionality of each one.</p>

<h4 id="creating-a-user">
<a class="anchor" href="#creating-a-user" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating a user</h4>
<p>I would start by checking for whether the variables we require were passed successfully. It’d be even better if we validated the types too.</p>

<p>If the username and password aren’t passed, we’re gonna want to throw an exception for express to handle later. We’re using the HTTP status code 422, for “Unprocessable Entity” and defining an internal error code to catch later. You can find a list of HTTP response codes <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">on mozilla’s HTTP response status codes</a> page.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">UserModel</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="kd">static</span> <span class="k">async</span> <span class="nx">create</span><span class="p">({</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">})</span> <span class="p">{</span>
        <span class="c1">// Check for username and password</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">username</span> <span class="o">||</span> <span class="o">!</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">({</span>
                <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Missing username or password</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">code</span><span class="p">:</span> <span class="dl">"</span><span class="s2">E_NOT_PROCESSABLE</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">status</span><span class="p">:</span> <span class="mi">422</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After that we need to insert the user into the database, check for duplicate user error, and I also want this method to return a new UserModel object so that we can begin work with the new user immediately.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">UserModel</span> <span class="p">{</span>
    <span class="p">...</span>

    <span class="kd">static</span> <span class="k">async</span> <span class="nx">create</span><span class="p">({</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">})</span> <span class="p">{</span>
        <span class="c1">// Check for username and password</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">username</span> <span class="o">||</span> <span class="o">!</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">({</span>
                <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Missing username or password</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">code</span><span class="p">:</span> <span class="dl">"</span><span class="s2">E_NOT_PROCESSABLE</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">status</span><span class="p">:</span> <span class="mi">422</span>
            <span class="p">})</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDb</span><span class="p">();</span>

        <span class="k">return</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="dl">"</span><span class="s2">INSERT INTO users (username, password) VALUES (?, ?);</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">])</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="o">===</span><span class="dl">'</span><span class="s1">SQLITE_CONSTRAINT: UNIQUE constraint failed: users.username</span><span class="dl">'</span><span class="p">){</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">({</span>
                    <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">User already exists</span><span class="dl">'</span><span class="p">,</span>
                    <span class="na">code</span><span class="p">:</span> <span class="dl">'</span><span class="s1">E_DUPLICATE_RESOURCE</span><span class="dl">'</span><span class="p">,</span>
                    <span class="na">status</span><span class="p">:</span> <span class="mi">409</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">//If we make it here, then we created a new user successfully.</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">UserModel</span><span class="p">({</span>
                <span class="nx">username</span><span class="p">,</span>
                <span class="nx">password</span><span class="p">,</span>
                <span class="na">id</span><span class="p">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">lastID</span>
            <span class="p">});</span>
        <span class="p">})</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="fetching-a-user">
<a class="anchor" href="#fetching-a-user" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fetching a user</h4>
<p>Fetching a user is a very similar process</p>
<ul>
  <li>Checking for user id or username</li>
  <li>Querying the database</li>
  <li>Checking for errors if the user doesn’t exist</li>
  <li>Returning a UserModel on success</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">UserModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kd">static</span> <span class="k">async</span> <span class="kd">get</span><span class="p">({</span><span class="nx">id</span><span class="p">,</span> <span class="nx">username</span><span class="p">})</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDb</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span> 
            <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">SELECT * FROM users where id = ?;</span><span class="dl">"</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">SELECT * FROM users where username = ?;</span><span class="dl">"</span><span class="p">,</span> <span class="nx">username</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">({</span>
                <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Missing user_id or username</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">code</span><span class="p">:</span> <span class="dl">"</span><span class="s2">E_UNPROCESSABLE_PARAMS</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">status</span><span class="p">:</span> <span class="mi">422</span>
            <span class="p">})</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">({</span>
                <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">User doesn't exist</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">code</span><span class="p">:</span> <span class="dl">"</span><span class="s2">E_RESOURCE_DOES_NOT_EXIST</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">status</span><span class="p">:</span> <span class="mi">404</span>
            <span class="p">})</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">UserModel</span><span class="p">({</span>
            <span class="na">username</span><span class="p">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
            <span class="na">password</span><span class="p">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span>
            <span class="na">id</span><span class="p">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">id</span>
         <span class="p">})</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="updating-user-data">
<a class="anchor" href="#updating-user-data" aria-hidden="true"><span class="octicon octicon-link"></span></a>Updating user data</h4>
<p>Updating a user is no different, we just need to build our sql statement based on whether we’re updating the username, password, or both. We need to throw an exception if we didn’t pass a property to update. Lastly, I want to update the current class object with the new data so the user can access it immediately without re-querying.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="kd">class</span> <span class="nx">UserModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">async</span> <span class="nx">update</span><span class="p">({</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">}){</span>
        <span class="kd">var</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDb</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">stmt</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">params</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stmt</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">UPDATE users SET username = ?, password = ? WHERE id = ?;</span><span class="dl">"</span><span class="p">;</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
        <span class="p">}</span> 
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stmt</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">UPDATE users SET username = ? WHERE id = ?;</span><span class="dl">"</span><span class="p">;</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>

        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stmt</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">UPDATE users SET password = ? WHERE id = ?;</span><span class="dl">"</span><span class="p">;</span>
            <span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="nx">password</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">({</span>
                <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Missing updated property.</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">code</span><span class="p">:</span> <span class="dl">"</span><span class="s2">E_NOT_PROCESSABLE</span><span class="dl">"</span><span class="p">,</span>
                <span class="na">status</span><span class="p">:</span> <span class="mi">422</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">stmt</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="c1">// After it runs, we should update our local data. We can assume it updated successfully.</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">username</span><span class="p">){</span>
                <span class="nb">self</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">username</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">self</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">password</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">})</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="deleting-a-user">
<a class="anchor" href="#deleting-a-user" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deleting a user</h4>
<p>Deleting a user is probably the easiest out of all of these. Literally the same as our unit testing lol.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">UserModel</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">async</span> <span class="k">delete</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDb</span><span class="p">();</span>
        <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="dl">"</span><span class="s2">DELETE FROM users WHERE id = ?;</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="fetching-user-tweets">
<a class="anchor" href="#fetching-user-tweets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fetching user tweets</h4>
<p>When fetching user tweets, I want it to return a list of Tweet objects created from our TweetModel, or an empty list if no tweets are found. There shouldn’t be any specific errors we need to watch for here.</p>

<p>We’re just querying the database with <code class="language-plaintext highlighter-rouge">db.all(sql)</code>, which fetches all rows which match the query, rather than <code class="language-plaintext highlighter-rouge">db.get(sql)</code> which only fetches the first match.</p>

<p>Then using array mapping to transform the data the query returned, to a list of TweetModel objects(imported as Tweet).</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">UserModel</span> <span class="p">{</span>
    <span class="k">async</span> <span class="nx">tweets</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">openDb</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="dl">"</span><span class="s2">SELECT * FROM tweets WHERE user_id = ?</span><span class="dl">"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[];</span>
        
        <span class="kd">const</span> <span class="nx">user_tweets</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span><span class="nx">t</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Tweet</span><span class="p">({</span>
            <span class="na">id</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="na">user_id</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">user_id</span><span class="p">,</span>
            <span class="na">content</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">content</span>
        <span class="p">}));</span>

        <span class="k">return</span> <span class="nx">user_tweets</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="tweetmodel">
<a class="anchor" href="#tweetmodel" aria-hidden="true"><span class="octicon octicon-link"></span></a>TweetModel</h3>
<p>It’s basically the same as the UserModel and I already hate how repetitive a single one gets. You can figure out this one or check the source code.</p>

<h1 id="unit-testing">
<a class="anchor" href="#unit-testing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Unit Testing</h1>
<p>Now that we’re familiar with testing, I want to get into the habit of unit testing everything as I build it.</p>

<p>Most of this is similar to when we CRUD tested the database, only this is abstracted.</p>

<h2 id="unit-testing-usermodel">
<a class="anchor" href="#unit-testing-usermodel" aria-hidden="true"><span class="octicon octicon-link"></span></a>Unit testing UserModel</h2>
<p>After creating the <code class="language-plaintext highlighter-rouge">tests/models.test.js</code> file, the first thing I want to do is create a group for unit testing the user model, and variables related to multiple tests(we’ll need them not to fall out of scope).</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">User</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../dist/models/UserModel</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Tweet</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../dist/models/TweetModel</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">username</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">models_u_rathma</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">somepass</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">newusername</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">models_u2_rathma</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">newpassword</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">somepass2</span><span class="dl">'</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">user</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="creating-a-user-1">
<a class="anchor" href="#creating-a-user-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating a user</h3>
<p>Since we’re working with a fresh database every time, we should be able to create a new user without checking for duplicate errors. We’re just going to use our <code class="language-plaintext highlighter-rouge">UserModel</code> class to create a new user and check that it returned a UserModel object.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User:Create</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="nx">username</span><span class="p">,</span>
            <span class="nx">password</span>
        <span class="p">});</span>
        <span class="c1">// Check that it returned a user correctly.</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">User</span><span class="p">));</span>
    <span class="p">})</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="fetching-a-user-1">
<a class="anchor" href="#fetching-a-user-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Fetching a user</h3>
<p>I don’t think I need to comment on this one. We’re just checking that it returns a valid user object.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User:Read</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="kd">get</span><span class="p">({</span><span class="nx">username</span><span class="p">});</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">User</span><span class="p">));</span>
    <span class="p">})</span>
    <span class="p">...</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="updating-a-user">
<a class="anchor" href="#updating-a-user" aria-hidden="true"><span class="octicon octicon-link"></span></a>Updating a user</h3>
<p>All we want to test here is that</p>
<ol>
  <li>When we update, the local object is updated</li>
  <li>The database object is also updated
    <div class="language-javascript highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
 <span class="p">...</span>
 <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User:Update</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="c1">// Separate updates first</span>
     <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">username</span><span class="p">:</span> <span class="nx">newusername</span><span class="p">});</span>
     <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">password</span><span class="p">:</span> <span class="nx">newpassword</span><span class="p">});</span>
     <span class="c1">//Check if they're changed in the local object.</span>
     <span class="nx">expect</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="nx">stringMatching</span><span class="p">(</span><span class="nx">newusername</span><span class="p">));</span>
     <span class="nx">expect</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="nx">stringMatching</span><span class="p">(</span><span class="nx">newpassword</span><span class="p">));</span>
     <span class="c1">// Now let's fetch the user again and check if it exists</span>
     <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="kd">get</span><span class="p">({</span><span class="na">username</span><span class="p">:</span> <span class="nx">newusername</span><span class="p">});</span>
     <span class="nx">expect</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">User</span><span class="p">));</span>
     <span class="c1">//Check variables set in properly.</span>
     <span class="nx">expect</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="nx">stringMatching</span><span class="p">(</span><span class="nx">newusername</span><span class="p">));</span>
     <span class="nx">expect</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expect</span><span class="p">.</span><span class="nx">stringMatching</span><span class="p">(</span><span class="nx">newpassword</span><span class="p">));</span>
 <span class="p">})</span>
 <span class="p">...</span>
<span class="p">})</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="deleting-a-user-1">
<a class="anchor" href="#deleting-a-user-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deleting a user</h3>
<p>Lastly, we want to check if our users are properly being removed from the database when we delete using the user object. Even if we attempt to delete a row that doesn’t exist in the database, it won’t throw an error, so no worries about error checking.</p>

<p>Since UserModel throws a 404, “User doesn’t exist” exception when we try to fetch a user that doesn’t exist, we can just test for that.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="nx">test</span><span class="p">(</span><span class="dl">'</span><span class="s1">Models:User:Delete</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Delete our user</span>
        <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="k">delete</span><span class="p">();</span>

        <span class="c1">// Try to fetch deleted user, should throw a 404 exception</span>
        <span class="kd">const</span> <span class="nx">get_user</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="kd">get</span><span class="p">({</span><span class="nx">username</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="k">await</span> <span class="nx">expect</span><span class="p">(</span><span class="nx">get_user</span><span class="p">()).</span><span class="nx">rejects</span><span class="p">.</span><span class="nx">toThrow</span><span class="p">(</span><span class="dl">"</span><span class="s2">User doesn't exist</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h1 id="closing">
<a class="anchor" href="#closing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Closing</h1>
<p>Even though we could have just used some sort of pre-baked ORM like sequelize, I think there’s a lot of value in designing stuff by hand occasionally. When I finish with the REST functionality, I’ll try out sequelize and firestore as alternative storage solutions.</p>

<p><a href="https://www.kyso.dev/express/webdev/jest/unit%20test/sqlite/2021/03/25/Unit-Testing.html">Previous Post: Unit Testing</a></p>

<h1 id="references">
<a class="anchor" href="#references" aria-hidden="true"><span class="octicon octicon-link"></span></a>References</h1>
<ul>
  <li><a href="https://github.com/mapbox/node-sqlite3/wiki/API">Sqlite3 API</a></li>
  <li><a href="https://www.npmjs.com/package/sqlite">Sqlite reference</a></li>
  <li><a href="https://github.com/mapbox/node-sqlite3/issues/57">Git issue: Defending against SQL injections</a></li>
  <li><a href="https://github.com/mapbox/node-sqlite3/issues/116">Git issue: Unhandled null parameters</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes">Javascript class reference</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">Mozilla HTTP Status Codes</a></li>
</ul>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="wrathofrathma/devlog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/express/webdev/sqlite/2021/03/29/Database-Abstraction.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A blog about stuff I find interesting.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/wrathofrathma" title="wrathofrathma"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/PriestOfRathma" title="PriestOfRathma"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
